{% extends 'default.html' %}
{% load static %}

{% block extra_css %}
<style>
    .recipe-title {
        font-family: 'Playfair Display', serif;
        font-style: italic;
        font-weight: bold;
        font-size: 35px;
        color: rgb(118, 0, 2);
        margin-top: 10px;
        text-align: center;
    }

    .recipe-container {
        display: grid;
        grid-template-columns: 1fr 1.5fr;
        gap: 20px;
        background-color: #f2ead7;
        padding: 20px;
        border-radius: 10px;
    }

    .recipe-photo {
        width: 100%;
        object-fit: cover;
        border: none;
        border-radius: 10px;
        background: white;
        box-shadow: 10px 10px 10px rgba(0,0,0,0.1);
    }

    .recipe-info {
       margin-top: 10px;
    }

    .author-link {
        font-family: 'Playfair Display', serif;
        font-style: italic;
        font-weight: bold;
        font-size: 20px;
        color: rgb(118, 0, 2);
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
        transform-origin: left center;
    }

    .author-link:hover {
        transform: scale(1.1);
        text-shadow: 0 0 8px rgba(118, 0, 2, 0.3);
    }

    .recipe-description {
        font-size: 16px;
        line-height: 1.3;
        background-color: white;
        border: none;
        border-radius: 10px;
        background: white;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);

    }

    .recipe-text {
        margin-top: 10px;
        border: none;
        border-radius: 10px;
        background: white;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        min-height: 400px;
        max-height: 100vh;
        overflow-y: auto;
    }

    .recipe-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .recipe-btn {
        display: inline-block;
        color: rgb(118, 0, 2);
        font-weight: bold;
        text-decoration: none;
        padding: 5px 10px;
        border: 1px solid black;
        border-radius: 5px;
        background: white;
        transition: transform 0.3s ease, text-shadow 0.3s ease;
    }

    .recipe-btn:hover {
        transform: scale(1.1);
        text-shadow: 0 0 8px rgba(200, 189, 176, 0.9);
    }

    .recipe-author {
        margin-top: 10px;
        font-size: 16px;
    }

    .rating-block {
        margin-top: 10px;
    }

    .star-rating {
        display: inline-block;
    }

    .star {
        font-size: 30px;
        color: #ccc;
        cursor: pointer;
        transition: color 0.2s, transform 0.2s;
    }

    .star:hover,
    .star.hovered {
        color: gold;
        transform: scale(1.2);
    }

    .star.selected {
        color: gold;
    }

    .back-button {
        margin-top: 30px;
        text-align: center;

    }

    .back-button a {
        display: inline-block;
        color: rgb(118, 0, 2);
        font-weight: bold;
        font-size: 16px;
        text-decoration: none;
        padding: 5px 10px;
        margin-top: 10px;
        border: 1px solid black;
        border-radius: 5px;
        background: white;
        transition: transform 0.3s ease, text-shadow 0.3s ease;
    }

    .back-button a:hover {
            transform: scale(1.1);
        text-shadow: 0 0 8px rgba(200, 189, 176, 0.9);
    }

    /* Модальное окно */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        backdrop-filter: blur(5px);
        background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        border-radius: 10px;
        width: 400px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
</style>
{% endblock %}

{% block navbar %}
    {% include "includes/navbars/main_navbar.html" %}
{% endblock %}

{% block content %}
<div class="content-area">
    <div class="recipe-title">{{ recipe.dish_name }}</div>

    <div class="recipe-container">
        <!-- Левая колонка -->
        <div>
            <img src="{{ recipe.picture.url }}" alt="{{ recipe.dish_name }}" class="recipe-photo">

            <div class="rating-block">
                <strong>Ваша оценка:</strong>
                {% if user.is_authenticated %}
                <form id="rating-form" method="post" action="{% url 'rate_recipe' recipe.pk %}">
                    {% csrf_token %}
                    <div class="star-rating">
                        {% for i in "12345" %}
                            <span class="star {% if user_rating and user_rating >= forloop.counter %}selected{% endif %}"
                                data-value="{{ forloop.counter }}">&#9733;</span>
                        {% endfor %}
                    </div>
                </form>
                {% else %}

                <div class="star-rating">
                    {% for i in "12345" %}
                        <span class="star" data-value="{{ forloop.counter }}">&#9733;</span>
                    {% endfor %}
                </div>
                {% endif %}
                <div class="average-rating">
                    Средняя оценка: <span id="average-rating">{{ recipe.average_rating|default:"0" }}</span> ⭐
                </div>
            </div>

            <div class="recipe-actions">

                <a href="#" id="favorite-btn" class="recipe-btn"
                data-url="{% url 'add_to_favorites' recipe.pk  %}">
                    {% if user.is_authenticated %}
                        {% if is_favorite %}
                            В избранном ✓
                        {% else %}
                            Сохранить в избранное
                        {% endif %}
                    {% else %}
                        Сохранить в избранное
                {% endif %}
                </a>
            </div>

            <div class="recipe-info">
                Автор: <a href="{% url 'user_profile' recipe.author.pk%}" class="author-link">
                {{ recipe.author.nickname }}
                </a>
                <p>Опубликовано <strong>{{ recipe.created_at|date:"d.m.Y" }}</strong></p>
            </div>
        </div>

        <!-- Правая колонка -->
        <div>
            <div class="recipe-description">{{ recipe.description }}</div>
            <div class="recipe-text">{{ recipe.text|safe }}</div>
        </div>
    </div>

    <!---Кнопка "Назад", возврат к прошлой странице-->
    <div class="back-button">
        <a href="{{ request.META.HTTP_REFERER|default:'/' }}">← Назад</a>
    </div>

    </div>

<!-- Модальное окно -->
<div id="login-modal" class="modal">
    <div class="modal-content">
        <h2>Действие доступно только зарегистрированным пользователям</h2>
        <p>Пожалуйста, <a href="{% url 'login' %}">войдите</a> или <a href="{% url 'signup'%}">зарегистрируйтесь</a>.</p>
        <button id="close-modal">Закрыть</button>
    </div>
</div>

<!-- AJAX-запросы -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const stars = document.querySelectorAll(".star-rating .star");
    const form = document.getElementById("rating-form");
    const avgRating = document.getElementById("average-rating");
    const modal = document.getElementById("login-modal");
    const closeModalBtn = document.getElementById("close-modal");

    const favoriteBtn = document.getElementById("favorite-btn");
    const favoriteUrl = favoriteBtn ? favoriteBtn.dataset.url : null;
    const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};

    // ====== ЗВЁЗДОЧКИ ======
    stars.forEach(star => {
        star.addEventListener("mouseover", function() {
            const val = parseInt(this.getAttribute("data-value"));
            stars.forEach(s => s.classList.toggle("hovered", parseInt(s.getAttribute("data-value")) <= val));
        });

        star.addEventListener("mouseout", function() {
            stars.forEach(s => s.classList.remove("hovered"));
        });

        star.addEventListener("click", function() {
            // Если нет формы — юзер не авторизован
            if (!form) {
                modal.style.display = "block";
                return;
            }
            const val = this.getAttribute("data-value");
            stars.forEach(s => s.classList.toggle("selected", parseInt(s.getAttribute("data-value")) <= val));

            const formData = new FormData(form);
            formData.append("rating", val);

            fetch(form.action, {
                method: "POST",
                body: formData
            })
            .then(() => {
                fetch(window.location.href)
                    .then(res => res.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, "text/html");
                        avgRating.textContent = doc.querySelector("#average-rating").textContent;
                    });
            });
        });
    });

    // ====== КНОПКА "СОХРАНИТЬ В ИЗБРАННОЕ" ======

    if (favoriteBtn) {
        favoriteBtn.addEventListener("click", function(e) {
            e.preventDefault();
            if (!isAuthenticated) {
                modal.style.display = "block";
                return;
            }

            fetch(favoriteUrl, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === "added") {
                    favoriteBtn.textContent = "В избранном ✓";
                } else if (data.status === "removed") {
                    favoriteBtn.textContent = "Сохранить в избранное";
                }
            });
        });
    }


    closeModalBtn.addEventListener("click", () => {
        modal.style.display = "none";
    });
});
</script>
{% endblock %}
